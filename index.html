<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized AI Career Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add the jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .skill-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 14px;
            margin: 4px;
        }
        .skill-tag button {
            margin-left: 8px;
            color: #4338ca;
            background: none;
            border: none;
            cursor: pointer;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dynamic-entry {
            border-left: 3px solid #d1d5db;
        }
        .ai-summary-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* AI Mentor Chat Styles */
        #chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-width: 90vw;
            height: 500px;
            max-height: 80vh;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(110%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        #chat-widget.open {
            transform: translateY(0);
        }
        .chat-message {
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: pulse 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <!-- Header -->
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Personalized AI Career Advisor</h1>
            <p class="text-slate-600 mt-2">Map your skills, discover your path, and prepare for the future.</p>
        </header>

        <!-- Main Advisor Card -->
        <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200">
            <!-- Step Indicators -->
            <div class="flex items-center justify-center space-x-2 md:space-x-4 mb-8">
                <div id="step-1-indicator" class="step-active flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold">1</div>
                    <span class="hidden md:inline">Profile</span>
                </div>
                <div class="flex-1 h-px bg-slate-200"></div>
                <div id="step-2-indicator" class="flex items-center space-x-2 text-slate-400">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold">2</div>
                    <span class="hidden md:inline">Resume</span>
                </div>
                <div class="flex-1 h-px bg-slate-200"></div>
                <div id="step-3-indicator" class="flex items-center space-x-2 text-slate-400">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold">3</div>
                    <span class="hidden md:inline">Goals</span>
                </div>
                 <div class="flex-1 h-px bg-slate-200"></div>
                <div id="step-4-indicator" class="flex items-center space-x-2 text-slate-400">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold">4</div>
                    <span class="hidden md:inline">Advice</span>
                </div>
            </div>

            <!-- Step 1: Profile & Skills -->
            <div id="step-1">
                <h2 class="text-xl font-semibold mb-4 text-slate-800">Tell us about yourself</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                        <input type="text" id="name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Alex Doe">
                    </div>
                    <div>
                        <label for="education" class="block text-sm font-medium text-slate-700 mb-1">Highest Education</label>
                        <select id="education" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option>High School</option>
                            <option>Bachelor's Degree</option>
                            <option>Master's Degree</option>
                            <option>PhD</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="field-of-study" class="block text-sm font-medium text-slate-700 mb-1">Field of Study</label>
                        <input type="text" id="field-of-study" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Computer Science">
                    </div>
                </div>
                <div class="mt-6">
                    <label for="skills-input" class="block text-sm font-medium text-slate-700 mb-1">Your Skills</label>
                    <p class="text-sm text-slate-500 mb-2">Enter your skills one by one and press Enter. (e.g., Python, Teamwork, SQL)</p>
                    <div class="border border-slate-300 rounded-lg p-2 flex flex-wrap items-center">
                        <div id="skills-container" class="flex flex-wrap"></div>
                        <input type="text" id="skills-input" class="flex-1 px-2 py-1 outline-none min-w-[150px]" placeholder="Add a skill...">
                    </div>
                </div>
                
                 <!-- AI Professional Summary -->
                 <div class="mt-6">
                    <button id="generate-summary-btn" class="w-full text-md bg-indigo-600 text-white font-semibold px-4 py-2.5 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center shadow-sm">
                        <span id="summary-btn-text"><i class="fas fa-wand-magic-sparkles mr-2"></i>Generate AI Professional Summary</span>
                        <span id="summary-spinner" class="hidden"><i class="fas fa-spinner fa-spin"></i>&nbsp;Generating...</span>
                    </button>
                    <div id="ai-summary-container" class="hidden mt-4 p-4 rounded-lg ai-summary-card border border-slate-200">
                        <h4 class="font-bold text-slate-800 mb-2">Your AI-Generated Summary:</h4>
                        <p id="ai-summary-text" class="text-slate-700 text-sm"></p>
                    </div>
                </div>

                 <div class="mt-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="build-resume-checkbox" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-slate-700">I want to build an ATS-friendly resume.</span>
                    </label>
                </div>
                <div id="step-1-error" class="text-red-500 text-sm mt-2 text-right h-5"></div>
                <div class="mt-2 text-right">
                    <button id="next-from-step-1-btn" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm">Next <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>
            
            <!-- Step 2: Resume Builder -->
            <div id="step-2" class="hidden">
                 <h2 class="text-xl font-semibold mb-4 text-slate-800">Build Your Resume</h2>
                 <!-- Contact Info -->
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div>
                        <label for="email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="email" placeholder="alex.doe@email.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                      </div>
                      <div>
                        <label for="phone" class="block text-sm font-medium text-slate-700 mb-1">Phone</label>
                        <input type="tel" id="phone" placeholder="(123) 456-7890" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                      </div>
                      <div>
                        <label for="linkedin" class="block text-sm font-medium text-slate-700 mb-1">LinkedIn URL</label>
                        <input type="url" id="linkedin" placeholder="linkedin.com/in/alexdoe" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                      </div>
                 </div>

                 <!-- Work Experience -->
                 <div class="mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Work Experience</h3>
                    <div id="experience-entries" class="space-y-4"></div>
                    <button id="add-experience-btn" class="mt-2 text-sm bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition"><i class="fas fa-plus mr-2"></i>Add Experience</button>
                 </div>
                 
                 <!-- Projects -->
                 <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Projects</h3>
                    <div id="project-entries" class="space-y-4"></div>
                    <button id="add-project-btn" class="mt-2 text-sm bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition"><i class="fas fa-plus mr-2"></i>Add Project</button>
                 </div>

                 <div class="mt-6 flex justify-between">
                     <button id="prev-to-step-1-btn" class="bg-slate-200 text-slate-800 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                     <button id="next-to-step-3-btn" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm">Next <i class="fas fa-arrow-right ml-2"></i></button>
                 </div>
            </div>

            <!-- Step 3: Goals & Interests -->
            <div id="step-3" class="hidden">
                 <h2 class="text-xl font-semibold mb-4 text-slate-800">What are your interests?</h2>
                 <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="interests" class="block text-sm font-medium text-slate-700">Describe your interests and career aspirations</label>
                        <button id="improve-interest-btn" class="text-sm bg-indigo-100 text-indigo-700 font-semibold px-3 py-1 rounded-md hover:bg-indigo-200 transition flex items-center">
                             <span id="improve-btn-text"><i class="fas fa-wand-magic-sparkles mr-2"></i>Improve with AI</span>
                             <span id="improving-spinner" class="hidden"><i class="fas fa-spinner fa-spin"></i>&nbsp;Improving...</span>
                        </button>
                    </div>
                    <textarea id="interests" rows="4" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., I love building web applications, am passionate about AI, or I enjoy leading teams and managing projects..."></textarea>
                 </div>
                 <div id="step-3-error" class="text-red-500 text-sm mt-2 text-right h-5"></div>
                 <div class="mt-2 flex justify-between">
                     <button id="prev-from-step-3-btn" class="bg-slate-200 text-slate-800 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                     <button id="get-advice-btn" class="bg-green-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-green-700 transition shadow-sm">
                        <span id="btn-text">Get AI Advice</span>
                        <span id="loading-spinner" class="hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...</span>
                     </button>
                 </div>
            </div>

        </main>
        
        <!-- Step 4: Results Section -->
        <div id="results-section" class="hidden mt-8">
            <div id="results-content" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
                <!-- Dynamic content will be injected here -->
            </div>
             <div id="job-opportunities-container" class="hidden mt-6 bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
                <!-- Live jobs will be injected here -->
            </div>
             <div id="interview-prep-container" class="hidden mt-6 bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
                <!-- Interview prep content will be injected here -->
            </div>
             <div class="mt-6 text-center space-x-2 md:space-x-4">
                <button id="mentor-chat-btn" class="bg-purple-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-purple-700 transition shadow-sm"><i class="fas fa-comments mr-2"></i>Chat with Mentor</button>
                <button id="interview-prep-btn" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm"><i class="fas fa-user-tie mr-2"></i>Mock Interview</button>
                <button id="download-resume-btn" class="bg-green-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-green-700 transition shadow-sm hidden"><i class="fas fa-download mr-2"></i>Download Resume</button>
                <button id="start-over-btn" class="bg-slate-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-slate-700 transition shadow-sm"><i class="fas fa-redo-alt mr-2"></i> Start Over</button>
            </div>
        </div>
        
    </div>

    <!-- AI Mentor Chat Widget -->
    <div id="chat-widget" class="bg-white border border-slate-300">
        <div class="bg-purple-600 text-white p-3 flex justify-between items-center">
            <h3 class="font-bold text-lg">Your AI Mentor</h3>
            <button id="close-chat-btn" class="text-white">&times;</button>
        </div>
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto flex flex-col bg-slate-50">
            <!-- Messages will be injected here -->
        </div>
        <div id="chat-typing-indicator" class="hidden p-4">
            <div class="ai-message typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="p-2 border-t border-slate-200 bg-white">
            <div class="flex items-center">
                <input type="text" id="chat-input" class="w-full px-3 py-2 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ask a follow-up question...">
                <button id="chat-send-btn" class="bg-purple-600 text-white px-4 py-2 rounded-r-md hover:bg-purple-700"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        const resultsSection = document.getElementById('results-section');
        const resultsContent = document.getElementById('results-content');
        
        // Navigation Buttons
        const nextFromStep1Btn = document.getElementById('next-from-step-1-btn');
        const prevToStep1Btn = document.getElementById('prev-to-step-1-btn');
        const nextToStep3Btn = document.getElementById('next-to-step-3-btn');
        const prevFromStep3Btn = document.getElementById('prev-from-step-3-btn');
        const getAdviceBtn = document.getElementById('get-advice-btn');
        const startOverBtn = document.getElementById('start-over-btn');
        const downloadResumeBtn = document.getElementById('download-resume-btn');
        const interviewPrepBtn = document.getElementById('interview-prep-btn');
        const mentorChatBtn = document.getElementById('mentor-chat-btn');

        // Step Indicators
        const step1Indicator = document.getElementById('step-1-indicator');
        const step2Indicator = document.getElementById('step-2-indicator');
        const step3Indicator = document.getElementById('step-3-indicator');
        const step4Indicator = document.getElementById('step-4-indicator');
        
        // Step 1 Elements
        const skillsInput = document.getElementById('skills-input');
        const skillsContainer = document.getElementById('skills-container');
        const buildResumeCheckbox = document.getElementById('build-resume-checkbox');
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const aiSummaryContainer = document.getElementById('ai-summary-container');
        const aiSummaryText = document.getElementById('ai-summary-text');
        const summaryBtnText = document.getElementById('summary-btn-text');
        const summarySpinner = document.getElementById('summary-spinner');


        // Step 2 (Resume) Elements
        const addExperienceBtn = document.getElementById('add-experience-btn');
        const experienceEntries = document.getElementById('experience-entries');
        const addProjectBtn = document.getElementById('add-project-btn');
        const projectEntries = document.getElementById('project-entries');
        let experienceCount = 0;
        let projectCount = 0;

        // Step 3 (Goals) Elements
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const improveInterestBtn = document.getElementById('improve-interest-btn');
        const improveBtnText = document.getElementById('improve-btn-text');
        const improvingSpinner = document.getElementById('improving-spinner');
        const interestsTextarea = document.getElementById('interests');

        // Step 4 Elements
        const interviewPrepContainer = document.getElementById('interview-prep-container');
        
        // AI Mentor Chat Elements
        const chatWidget = document.getElementById('chat-widget');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatTypingIndicator = document.getElementById('chat-typing-indicator');

        // Live Jobs Elements
        const jobOpportunitiesContainer = document.getElementById('job-opportunities-container');

        let userSkills = [];
        let careerRecommendations = []; // Store AI recommendations
        let chatHistory = [];

        const learningResources = {
            "html": { title: "HTML Full Course", url: "https://www.freecodecamp.org/news/html-full-course/" },
            "css": { title: "CSS Tutorial", url: "https://www.w3schools.com/css/" },
            "javascript": { title: "JavaScript Algorithms and Data Structures", url: "https://www.freecodecamp.org/learn/javascript-algorithms-and-data-structures/" },
            "react": { title: "Official React Tutorial", url: "https://react.dev/learn" },
            "python": { title: "Python for Everybody", url: "https://www.coursera.org/specializations/python" },
            "sql": { title: "SQLBolt - Interactive SQL Tutorial", url: "https://sqlbolt.com/" },
            "machine learning": { title: "Machine Learning by Andrew Ng", url: "https://www.coursera.org/learn/machine-learning" },
            "agile": { title: "Introduction to Agile Development", url: "https://www.coursera.org/learn/agile-development-intro"},
            "figma": { title: "Figma for Beginners", url: "https://www.youtube.com/watch?v=eZJOSK4gXl4" },
            "vue": { title: "Vue.js Official Tutorial", url: "https://vuejs.org/guide/quick-start.html" },
            "git": { title: "Git & GitHub for Beginners", url: "https://www.youtube.com/watch?v=RGOj5yH7evk" },
            "responsive design": { title: "Responsive Web Design Fundamentals", url: "https://web.dev/learn/design/" },
            "java": { title: "Java Programming Masterclass", url: "https://www.udemy.com/course/java-the-complete-java-developer-course/" },
            "nodejs": { title: "Node.js and Express.js - Full Course", url: "https://www.freecodecamp.org/news/node-js-express-js-course/" },
            "api": { title: "Postman API Fundamentals", url: "https://www.postman.com/student-program/student-expert/" },
            "docker": { title: "Docker for Absolute Beginners", url: "https://www.youtube.com/watch?v=pg19Z8LL06w" },
            "cloud": { title: "Cloud Computing with AWS", url: "https://www.coursera.org/learn/aws-cloud-practitioner-essentials" },
            "r": { title: "R Programming A-Zâ„¢", url: "https://www.udemy.com/course/r-programming/" },
            "statistics": { title: "Statistics and Probability", url: "https://www.khanacademy.org/math/statistics-probability" },
            "data visualization": { title: "Data Visualization with D3.js", url: "https://www.freecodecamp.org/news/d3js-tutorial/" },
            "scrum": { title: "Scrum 101", url: "https://www.youtube.com/watch?v=9TycLR0TqFA" },
            "leadership": { title: "Leadership and Emotional Intelligence", url: "https://www.coursera.org/learn/leadership-emotional-intelligence" },
            "user research": { title: "Google UX Design Certificate", url: "https://www.coursera.org/professional-certificates/google-ux-design" },
            "prototyping": { title: "Prototyping and Design", url: "https://www.interaction-design.org/courses/ui-design-patterns-for-successful-software" }
        };
        
        // --- Event Listeners ---
        
        nextFromStep1Btn.addEventListener('click', () => {
            if (skillsInput.value.trim() !== '') {
                addSkillsFromInput(skillsInput.value);
                skillsInput.value = '';
            }
            if (document.getElementById('name').value.trim() === '' || userSkills.length === 0) {
                showError('Please enter your name and at least one skill.', 1);
                return;
            }
            step1.classList.add('hidden');
            if (buildResumeCheckbox.checked) {
                step2.classList.remove('hidden');
                updateStepIndicator(2);
            } else {
                step3.classList.remove('hidden');
                updateStepIndicator(3);
            }
        });

        prevToStep1Btn.addEventListener('click', () => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            updateStepIndicator(1);
        });
        
        nextToStep3Btn.addEventListener('click', () => {
            step2.classList.add('hidden');
            step3.classList.remove('hidden');
            updateStepIndicator(3);
        });

        prevFromStep3Btn.addEventListener('click', () => {
            step3.classList.add('hidden');
             if (buildResumeCheckbox.checked) {
                step2.classList.remove('hidden');
                updateStepIndicator(2);
            } else {
                step1.classList.remove('hidden');
                updateStepIndicator(1);
            }
        });

        getAdviceBtn.addEventListener('click', () => {
            if (document.getElementById('interests').value.trim() === '') {
                showError('Please describe your interests.', 3);
                return;
            }
            getAIRecommendations();
        });
        
        generateSummaryBtn.addEventListener('click', generateSummaryWithAI);
        interviewPrepBtn.addEventListener('click', showInterviewPrep);

        startOverBtn.addEventListener('click', () => window.location.reload());
        downloadResumeBtn.addEventListener('click', downloadResume);
        improveInterestBtn.addEventListener('click', handleInterestImproveClick);
        
        skillsInput.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' || e.key === ',') && skillsInput.value.trim() !== '') {
                e.preventDefault();
                addSkillsFromInput(skillsInput.value);
                skillsInput.value = '';
            }
        });

        skillsInput.addEventListener('blur', () => {
            if (skillsInput.value.trim() !== '') {
                addSkillsFromInput(skillsInput.value);
                skillsInput.value = '';
            }
        });

        addExperienceBtn.addEventListener('click', addExperienceEntry);
        addProjectBtn.addEventListener('click', addProjectEntry);
        
        // Event delegation for dynamic "Improve with AI" buttons
        experienceEntries.addEventListener('click', handleDynamicImproveClick);
        projectEntries.addEventListener('click', handleDynamicImproveClick);
        
        // Chat event listeners
        mentorChatBtn.addEventListener('click', () => {
            chatWidget.classList.add('open');
            // Add a welcome message if it's the first time opening the chat
            if (chatHistory.length === 0) {
                // The AI message will also be added to chatHistory via this function
                addMessageToChat('ai', `Hi! I'm your AI Mentor. Feel free to ask me anything about your recommended career paths.`);
            }
        });
        closeChatBtn.addEventListener('click', () => chatWidget.classList.remove('open'));
        chatSendBtn.addEventListener('click', handleChatMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleChatMessage();
            }
        });

        // Job Opportunities event listener
        jobOpportunitiesContainer.addEventListener('click', handleJobOpportunitiesClick);

        // --- Functions ---

        function showError(message, step) {
            const errorDiv = document.getElementById(`step-${step}-error`);
            if (errorDiv) {
                errorDiv.textContent = message;
                setTimeout(() => { if (errorDiv) errorDiv.textContent = ''; }, 3000);
            }
        }
        
        function updateStepIndicator(step) {
            [step1Indicator, step2Indicator, step3Indicator, step4Indicator].forEach((indicator, index) => {
                indicator.classList.remove('step-active');
                indicator.querySelector('div').classList.remove('bg-blue-600', 'text-white');
                if (step >= (index + 1)) {
                    indicator.classList.add('step-active');
                    indicator.querySelector('div').classList.add('bg-blue-600', 'text-white');
                }
            });
             if (!buildResumeCheckbox.checked && step > 1) {
                step2Indicator.classList.remove('step-active');
             }
        }
        
        function addSkill(skill) {
            const normalizedSkill = skill.toLowerCase();
            if (normalizedSkill && !userSkills.includes(normalizedSkill)) {
                userSkills.push(normalizedSkill);
                renderSkills();
            }
        }

        function addSkillsFromInput(inputText) {
            const skills = inputText.split(',').map(s => s.trim()).filter(Boolean);
            skills.forEach(addSkill);
        }

        function removeSkill(skill) {
            userSkills = userSkills.filter(s => s !== skill);
            renderSkills();
        }

        function renderSkills() {
            skillsContainer.innerHTML = '';
            userSkills.forEach(skill => {
                const skillTag = document.createElement('div');
                skillTag.className = 'skill-tag';
                skillTag.innerHTML = `<span>${skill}</span><button onclick="removeSkill('${skill}')"><i class="fas fa-times"></i></button>`;
                skillsContainer.appendChild(skillTag);
            });
        }

        function addExperienceEntry() {
            experienceCount++;
            const entry = document.createElement('div');
            entry.className = 'dynamic-entry p-4 space-y-3 bg-slate-50 rounded-r-lg';
            entry.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" placeholder="Job Title" class="w-full px-3 py-2 border rounded-md" id="exp-title-${experienceCount}">
                    <input type="text" placeholder="Company" class="w-full px-3 py-2 border rounded-md" id="exp-company-${experienceCount}">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" placeholder="Start Date (e.g., Jan 2022)" class="w-full px-3 py-2 border rounded-md" id="exp-start-${experienceCount}">
                    <input type="text" placeholder="End Date (e.g., Present)" class="w-full px-3 py-2 border rounded-md" id="exp-end-${experienceCount}">
                </div>
                <div class="relative">
                    <textarea placeholder="Key responsibilities and achievements..." rows="3" class="w-full px-3 py-2 border rounded-md" id="exp-desc-${experienceCount}"></textarea>
                    <button class="improve-ai-btn absolute bottom-2 right-2 text-xs bg-indigo-100 text-indigo-700 font-semibold px-2 py-1 rounded-md hover:bg-indigo-200 transition flex items-center" data-target-id="exp-desc-${experienceCount}" data-context="experience">
                        <span class="btn-text"><i class="fas fa-wand-magic-sparkles mr-1"></i>Improve</span>
                        <span class="spinner hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            `;
            experienceEntries.appendChild(entry);
        }

        function addProjectEntry() {
            projectCount++;
            const entry = document.createElement('div');
            entry.className = 'dynamic-entry p-4 space-y-3 bg-slate-50 rounded-r-lg';
            entry.innerHTML = `
                <input type="text" placeholder="Project Name" class="w-full px-3 py-2 border rounded-md" id="proj-name-${projectCount}">
                <div class="relative">
                    <textarea placeholder="Project description and your role..." rows="3" class="w-full px-3 py-2 border rounded-md" id="proj-desc-${projectCount}"></textarea>
                    <button class="improve-ai-btn absolute bottom-2 right-2 text-xs bg-indigo-100 text-indigo-700 font-semibold px-2 py-1 rounded-md hover:bg-indigo-200 transition flex items-center" data-target-id="proj-desc-${projectCount}" data-context="project">
                        <span class="btn-text"><i class="fas fa-wand-magic-sparkles mr-1"></i>Improve</span>
                        <span class="spinner hidden"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
                <input type="text" placeholder="Technologies Used (e.g., React, Node.js)" class="w-full px-3 py-2 border rounded-md" id="proj-tech-${projectCount}">
            `;
            projectEntries.appendChild(entry);
        }

        async function handleInterestImproveClick() {
            const currentInterests = interestsTextarea.value;
            if (currentInterests.trim() === '') {
                showError("Please write something first to improve it.", 3);
                return;
            }
            improveBtnText.classList.add('hidden');
            improvingSpinner.classList.remove('hidden');
            improveInterestBtn.disabled = true;

            try {
                const improvedText = await improveTextWithAIApiCall(currentInterests, 'interest');
                if(improvedText) interestsTextarea.value = improvedText;
            } catch(error) {
                 console.error("Error improving text with AI:", error);
                showError('Could not improve text. Please try again.', 3);
            } finally {
                improveBtnText.classList.remove('hidden');
                improvingSpinner.classList.add('hidden');
                improveInterestBtn.disabled = false;
            }
        }
        
        async function handleDynamicImproveClick(event) {
            const button = event.target.closest('.improve-ai-btn');
            if (!button) return;

            const targetId = button.dataset.targetId;
            const context = button.dataset.context;
            const textarea = document.getElementById(targetId);

            if (!textarea || textarea.value.trim() === '') return;

            const btnText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.spinner');

            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            button.disabled = true;

            try {
                const improvedText = await improveTextWithAIApiCall(textarea.value, context);
                if(improvedText) textarea.value = improvedText;
            } catch(error) {
                 console.error(`Error improving ${context}:`, error);
            } finally {
                btnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                button.disabled = false;
            }
        }

        async function improveTextWithAIApiCall(text, context) {
            const apiKey = "AIzaSyB0FBnF8QlDZJSxHnYlbDi8ddgkQR1Ik4I";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let prompt;
            switch (context) {
                case 'summary':
                    const name = document.getElementById('name').value;
                    const education = document.getElementById('education').value;
                    const fieldOfStudy = document.getElementById('field-of-study').value;
                    let educationText = education;
                    if (fieldOfStudy.trim() !== '') {
                        educationText += ` in ${fieldOfStudy}`;
                    }
                    prompt = `Generate a 2-sentence professional summary in the first person (e.g., "I am a...") for someone with a ${educationText} and skills in ${userSkills.join(', ')}. The summary should be inspiring and suitable for a LinkedIn profile. Do not add any preamble.`;
                    break;
                case 'experience':
                    prompt = `Rewrite the following user's work experience description to be more professional and achievement-oriented. Use action verbs and quantify results where possible. Format the output as a few concise bullet points or a short paragraph. Do not add any preamble. Original text: "${text}"`;
                    break;
                case 'project':
                    prompt = `Rewrite the following user's project description to be more professional, highlighting the problem solved, the key technologies used, and the user's specific contributions. Do not add any preamble. Original text: "${text}"`;
                    break;
                case 'interest':
                default:
                    prompt = `Rewrite the following user's interest description to be more professional, elaborate, and suitable for a career advisor. Expand on the core ideas, turning simple phrases into a compelling statement of passion and aspiration. Keep the response concise (2-4 sentences) and written in the first person. Do not add any preamble. Original text: "${text}"`;
                    break;
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text.trim();
            } else {
                throw new Error("Invalid response structure from AI.");
            }
        }
        
         async function generateSummaryWithAI() {
            if (document.getElementById('name').value.trim() === '' || userSkills.length === 0) {
                showError('Please enter your name and skills before generating a summary.', 1);
                return;
            }
            summaryBtnText.classList.add('hidden');
            summarySpinner.classList.remove('hidden');
            generateSummaryBtn.disabled = true;

            try {
                const improvedText = await improveTextWithAIApiCall('', 'summary');
                if (improvedText) {
                    aiSummaryText.textContent = improvedText;
                    aiSummaryContainer.classList.remove('hidden');
                }
            } catch(error) {
                console.error("Error generating summary:", error);
                showError('Could not generate summary. Please try again.', 1);
            } finally {
                summaryBtnText.classList.remove('hidden');
                summarySpinner.classList.add('hidden');
                generateSummaryBtn.disabled = false;
            }
        }

        async function getAIRecommendations() {
            btnText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            getAdviceBtn.disabled = true;

            const apiKey = "AIzaSyB0FBnF8QlDZJSxHnYlbDi8ddgkQR1Ik4I";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const userName = document.getElementById('name').value;
            const interestsText = document.getElementById('interests').value;
            const skillsText = userSkills.join(', ');
            const prompt = `Based on the following user profile, recommend two distinct career paths. User Skills: ${skillsText}. User Interests: ${interestsText}. Provide the response as a single, valid JSON object with a key "careers" which is an array of two career objects. Each object must have the following keys and data types: "title": a string, "description": a string, "requiredSkills": an array of 5-7 lowercase strings, "avgSalary": a string, "outlook": a string. Do not include any other text or markdown formatting. The entire output must be only the JSON object itself.`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
                }
                const result = await response.json();
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("Invalid response structure from AI.");
                
                const rawJsonText = result.candidates[0].content.parts[0].text;
                // Robust JSON cleaning
                const fenceRegex = /```json/g;
                const backtickRegex = /```/g;
                const trailingCommaBracketRegex = /,\s*]/g;
                const trailingCommaBraceRegex = /,\s*}/g;

                let cleanedJsonText = rawJsonText.replace(fenceRegex, '').replace(backtickRegex, '').trim();
                cleanedJsonText = cleanedJsonText.replace(trailingCommaBracketRegex, ']').replace(trailingCommaBraceRegex, '}');
                
                const recommendations = JSON.parse(cleanedJsonText);
                if (recommendations.careers && recommendations.careers.length >= 2) {
                    careerRecommendations = recommendations.careers; // Save for interview prep
                    displayResults(userName, careerRecommendations[0], careerRecommendations[1]);
                } else {
                    throw new Error("AI response did not contain two career paths.");
                }
            } catch (error) {
                console.error("Error fetching AI recommendations:", error);
                showError('Could not get AI advice. Please try again.', 3);
            } finally {
                btnText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                getAdviceBtn.disabled = false;
                document.querySelector('main').classList.add('hidden');
                resultsSection.classList.remove('hidden');
                updateStepIndicator(4);
                 if (buildResumeCheckbox.checked) {
                    downloadResumeBtn.classList.remove('hidden');
                }
                // Show job opportunities after results
                showLiveJobs();
            }
        }
        
        function displayResults(userName, topMatch, secondMatch) {
            const topMatchSkillGap = topMatch.requiredSkills.filter(skill => !userSkills.includes(skill.toLowerCase()));
            const topMatchKnownSkills = topMatch.requiredSkills.filter(skill => userSkills.includes(skill.toLowerCase()));
            const secondMatchSkillGap = secondMatch.requiredSkills.filter(skill => !userSkills.includes(skill.toLowerCase()));
            const secondMatchKnownSkills = secondMatch.requiredSkills.filter(skill => userSkills.includes(skill.toLowerCase()));
            
            resultsContent.innerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-2">Your Personalized Career Advice, ${userName}!</h2>
                <p class="text-slate-600 mb-6">Based on your skills and interests, here are our top recommendations for you.</p>
                <div class="border-2 border-blue-500 rounded-xl p-6 mb-8 bg-blue-50/50">
                    <h3 class="text-xl font-bold text-blue-800">${topMatch.title}</h3>
                    <p class="text-slate-700 mt-1 mb-4">${topMatch.description}</p>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center"><i class="fas fa-dollar-sign text-green-500 mr-2"></i>Avg. Salary: <span class="font-semibold ml-1">${topMatch.avgSalary}</span></div>
                        <div class="flex items-center"><i class="fas fa-chart-line text-purple-500 mr-2"></i>Job Outlook: <span class="font-semibold ml-1">${topMatch.outlook}</span></div>
                    </div>
                </div>
                <div class="mb-8">
                     <h3 class="text-xl font-semibold mb-4 text-slate-800">Projected 15-Year Growth for a ${topMatch.title}</h3>
                     <div class="border border-slate-200 rounded-lg p-4" style="height: 250px;"><canvas id="growthChart"></canvas></div>
                </div>
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800">Your Roadmap to Become a ${topMatch.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-slate-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3"><i class="fas fa-check-circle text-green-500 mr-2"></i>Skills You Have</h4>
                            <div class="flex flex-wrap gap-2">${topMatchKnownSkills.length > 0 ? topMatchKnownSkills.map(s => `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${s}</span>`).join('') : '<p class="text-slate-500 text-sm">No matching skills yet.</p>'}</div>
                            <h4 class="font-semibold mt-4 mb-3"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Skills to Develop</h4>
                            <div class="flex flex-wrap gap-2">${topMatchSkillGap.map(s => `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${s}</span>`).join('')}</div>
                        </div>
                        <div class="border border-slate-200 rounded-lg p-4">
                            <h4 class="font-semibold mb-3"><i class="fas fa-book-open text-blue-500 mr-2"></i>Recommended Learning</h4>
                            <ul class="space-y-2">${topMatchSkillGap.slice(0, 4).map(skill => { const r = learningResources[skill.toLowerCase()]; return r ? `<li><a href="${r.url}" target="_blank" class="text-blue-600 hover:underline text-sm">${r.title} for ${skill}</a></li>` : ''; }).join('')}</ul>
                        </div>
                    </div>
                </div>
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800">Another Great Option: ${secondMatch.title}</h3>
                     <div class="border border-slate-300 rounded-xl p-6 bg-slate-50">
                        <p class="text-slate-700 mt-1 mb-4">${secondMatch.description}</p>
                        <div class="flex flex-wrap gap-4 text-sm mb-4">
                            <div class="flex items-center"><i class="fas fa-dollar-sign text-green-500 mr-2"></i>Avg. Salary: <span class="font-semibold ml-1">${secondMatch.avgSalary}</span></div>
                            <div class="flex items-center"><i class="fas fa-chart-line text-purple-500 mr-2"></i>Job Outlook: <span class="font-semibold ml-1">${secondMatch.outlook}</span></div>
                        </div>
                         <div class="border-t border-slate-300 pt-4">
                            <h4 class="font-semibold mb-3">Your Skill Match</h4>
                             <div class="flex flex-wrap gap-2">${secondMatchKnownSkills.length > 0 ? secondMatchKnownSkills.map(s => `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${s}</span>`).join('') : '<p class="text-slate-500 text-sm">No matching skills.</p>'}</div>
                            <h4 class="font-semibold mt-4 mb-3">Skills to Develop</h4>
                             <div class="flex flex-wrap gap-2">${secondMatchSkillGap.map(s => `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${s}</span>`).join('')}</div>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                     <h3 class="text-xl font-semibold mb-4 text-slate-800">Next Steps: Prepare for Interviews</h3>
                     <ul class="list-disc list-inside space-y-2 text-slate-700">
                        <li>Research the roles and responsibilities of a ${topMatch.title} and a ${secondMatch.title}.</li>
                        <li>Build a portfolio project that showcases a mix of your skills.</li>
                        <li>Tailor your resume to the specific job you're applying for.</li>
                     </ul>
                </div>
            `;
            renderGrowthChart(topMatch);
            window.scrollTo(0, 0);
        }
        
         function showLiveJobs() {
            if (careerRecommendations.length === 0) return;
            jobOpportunitiesContainer.classList.remove('hidden');

            const topCareerTitle = careerRecommendations[0].title;
            const secondCareerTitle = careerRecommendations[1].title;

            // Mock job data for simulation
            const mockJobs = [
                { title: topCareerTitle, company: 'Innovatech Solutions', location: 'Remote', description: 'Seeking a proactive developer to build scalable backend services. Experience with cloud platforms is a plus.' },
                { title: topCareerTitle, company: 'Data Dynamics', location: 'New York, NY', description: 'Join our data engineering team to design and implement robust data pipelines and ETL processes.' },
                { title: secondCareerTitle, company: 'Creative Minds Inc.', location: 'San Francisco, CA', description: 'We are looking for a skilled professional to analyze business processes and create data-driven solutions.' },
                { title: secondCareerTitle, company: 'Health Analytics Co.', location: 'Boston, MA', description: 'Leverage data to provide insights into healthcare trends and patient outcomes.' }
            ];

            let jobsHTML = `<h3 class="text-2xl font-bold text-slate-900 mb-4">Live Job Opportunities</h3>`;
            mockJobs.forEach((job, index) => {
                jobsHTML += `
                    <div class="border border-slate-200 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">${job.title}</h4>
                                <p class="text-sm text-slate-600">${job.company} - ${job.location}</p>
                                <p class="text-sm text-slate-500 mt-2">${job.description}</p>
                            </div>
                            <button class="generate-cover-letter-btn text-sm bg-green-100 text-green-800 font-semibold px-3 py-1 rounded-md hover:bg-green-200 transition flex-shrink-0" data-job-index="${index}">
                                <span class="btn-text"><i class="fas fa-file-alt mr-2"></i>Generate Cover Letter</span>
                                <span class="spinner hidden"><i class="fas fa-spinner fa-spin"></i></span>
                            </button>
                        </div>
                        <div id="cover-letter-container-${index}" class="hidden mt-3 p-3 bg-slate-50 rounded-md border border-slate-200">
                             <textarea class="w-full h-48 text-sm border-slate-300 rounded-md"></textarea>
                             <button class="copy-cover-letter-btn text-xs bg-slate-200 px-2 py-1 rounded-md mt-1">Copy</button>
                        </div>
                    </div>
                `;
            });
            jobOpportunitiesContainer.innerHTML = jobsHTML;
        }

        async function handleJobOpportunitiesClick(event) {
            const generateBtn = event.target.closest('.generate-cover-letter-btn');
            const copyBtn = event.target.closest('.copy-cover-letter-btn');

            if (generateBtn) {
                const jobIndex = generateBtn.dataset.jobIndex;
                const container = document.getElementById(`cover-letter-container-${jobIndex}`);
                const textarea = container.querySelector('textarea');
                
                const btnText = generateBtn.querySelector('.btn-text');
                const spinner = generateBtn.querySelector('.spinner');
                
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
                generateBtn.disabled = true;

                try {
                    const coverLetter = await generateCoverLetter(jobIndex);
                    textarea.value = coverLetter;
                    container.classList.remove('hidden');
                } catch (error) {
                    console.error('Failed to generate cover letter:', error);
                    textarea.value = "Sorry, couldn't generate the cover letter. Please try again.";
                    container.classList.remove('hidden');
                } finally {
                    btnText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            }

            if (copyBtn) {
                const container = copyBtn.closest('[id^="cover-letter-container-"]');
                const textarea = container.querySelector('textarea');
                textarea.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
            }
        }

        async function generateCoverLetter(jobIndex) {
            // Re-using the mock data from showLiveJobs, in a real app you'd pass this data around
            const topCareerTitle = careerRecommendations[0].title;
            const secondCareerTitle = careerRecommendations[1].title;
             const mockJobs = [
                { title: topCareerTitle, company: 'Innovatech Solutions', location: 'Remote', description: 'Seeking a proactive developer to build scalable backend services. Experience with cloud platforms is a plus.' },
                { title: topCareerTitle, company: 'Data Dynamics', location: 'New York, NY', description: 'Join our data engineering team to design and implement robust data pipelines and ETL processes.' },
                { title: secondCareerTitle, company: 'Creative Minds Inc.', location: 'San Francisco, CA', description: 'We are looking for a skilled professional to analyze business processes and create data-driven solutions.' },
                { title: secondCareerTitle, company: 'Health Analytics Co.', location: 'Boston, MA', description: 'Leverage data to provide insights into healthcare trends and patient outcomes.' }
            ];
            const job = mockJobs[jobIndex];
            const userName = document.getElementById('name').value;
            const summary = aiSummaryText.textContent || document.getElementById('interests').value;

            const apiKey = "AIzaSyB0FBnF8QlDZJSxHnYlbDi8ddgkQR1Ik4I";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `You are a professional career coach. Write a compelling cover letter for ${userName} applying for the position of ${job.title} at ${job.company}. The user's professional summary is: "${summary}". The user's skills are: ${userSkills.join(', ')}. The job description mentions: "${job.description}". The cover letter should be professional, concise (3 paragraphs), and highlight how the user's skills and summary match the job requirements. Address it to the "Hiring Team" and do not include placeholders for contact info.`;
            
             const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text.trim();
            } else {
                throw new Error("Invalid response structure from AI for cover letter.");
            }
        }

         function showInterviewPrep() {
            if (careerRecommendations.length === 0) return;
            interviewPrepContainer.classList.remove('hidden');
            interviewPrepContainer.innerHTML = `
                <h3 class="text-2xl font-bold text-slate-900 mb-4">Mock Interview Prep</h3>
                <div class="mb-4">
                    <label for="career-select" class="block text-sm font-medium text-slate-700 mb-1">Select a career to prepare for:</label>
                    <select id="career-select" class="w-full md:w-1/2 px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="0">${careerRecommendations[0].title}</option>
                        <option value="1">${careerRecommendations[1].title}</option>
                    </select>
                </div>
                <div id="interview-questions-container">
                    <div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-slate-500"></i></div>
                </div>
            `;
            const careerSelect = document.getElementById('career-select');
            careerSelect.addEventListener('change', (e) => getInterviewQuestions(e.target.value));
            getInterviewQuestions(0); // Load questions for the first career by default
        }

        async function getInterviewQuestions(careerIndex) {
            const container = document.getElementById('interview-questions-container');
            container.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-slate-500"></i></div>`;

            const careerTitle = careerRecommendations[careerIndex].title;
            const apiKey = "AIzaSyB0FBnF8QlDZJSxHnYlbDi8ddgkQR1Ik4I";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Generate 3 behavioral and 3 technical interview questions for a ${careerTitle} role. Also, provide a brief sample answer outline for the first behavioral question using the STAR method. Return this as a single, valid JSON object with keys: "behavioralQuestions" (array of strings), "technicalQuestions" (array of strings), and "sampleAnswer" (a string with STAR method breakdown). Do not include any other text or markdown formatting.`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API call for interview questions failed');
                const result = await response.json();
                const rawJsonText = result.candidates[0].content.parts[0].text;
                
                // Robust JSON cleaning
                const fenceRegex = /```json/g;
                const backtickRegex = /```/g;
                const trailingCommaBracketRegex = /,\s*]/g;
                const trailingCommaBraceRegex = /,\s*}/g;

                let cleanedJsonText = rawJsonText.replace(fenceRegex, '').replace(backtickRegex, '').trim();
                cleanedJsonText = cleanedJsonText.replace(trailingCommaBracketRegex, ']').replace(trailingCommaBraceRegex, '}');

                const data = JSON.parse(cleanedJsonText);

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-slate-800 mb-3">Behavioral Questions</h4>
                            <ul class="list-disc list-inside space-y-2 text-slate-700">${data.behavioralQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
                        </div>
                         <div>
                            <h4 class="text-lg font-semibold text-slate-800 mb-3">Technical Questions</h4>
                            <ul class="list-disc list-inside space-y-2 text-slate-700">${data.technicalQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
                        </div>
                    </div>
                    <div class="mt-6 border-t border-slate-200 pt-4">
                        <h4 class="text-lg font-semibold text-slate-800 mb-3">Sample Answer Framework (STAR Method)</h4>
                        <p class="text-sm font-semibold text-slate-600">${data.behavioralQuestions[0]}</p>
                        <p class="text-slate-700 whitespace-pre-wrap mt-2 text-sm">${data.sampleAnswer}</p>
                    </div>
                `;

            } catch (error) {
                console.error("Error fetching interview questions:", error);
                container.innerHTML = `<p class="text-red-500">Could not load interview questions. Please try again.</p>`;
            }
        }


        function renderGrowthChart(career) {
            const ctx = document.getElementById('growthChart');
            if (!ctx) return;
            const currentYear = new Date().getFullYear();
            const years = Array.from({length: 15}, (_, i) => currentYear - 14 + i);
            let growthData = [];
            let currentJobs = 50;
            for(let i = 0; i < 15; i++) {
                const fluctuation = (Math.random() - 0.4) * 5;
                const growthFactor = 1 + (Math.random() * 5) / 100;
                currentJobs = currentJobs * growthFactor + fluctuation;
                growthData.push(Math.max(currentJobs, 0));
            }
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: `Job Market Growth (in thousands)`,
                        data: growthData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Relative Number of Jobs'}}, x: { title: {display: true, text: 'Year'}}},
                    plugins: { legend: { display: false }}
                }
            });
        }
        
        function downloadResume() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const linkedin = document.getElementById('linkedin').value;
            const education = document.getElementById('education').value;
            const fieldOfStudy = document.getElementById('field-of-study').value;
            let summary = aiSummaryText.textContent || document.getElementById('interests').value;

            const margin = 20;
            let yPos = margin;

            // --- Header ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text(name.toUpperCase(), margin, yPos);
            yPos += 10;
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text(`${email} | ${phone} | ${linkedin}`, margin, yPos);
            yPos += 10;
            doc.line(margin, yPos - 5, 190, yPos - 5); // Horizontal line

            // --- Summary ---
            yPos += 5;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("SUMMARY", margin, yPos);
            yPos += 6;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            const summaryLines = doc.splitTextToSize(summary, 170); // 170mm width
            doc.text(summaryLines, margin, yPos);
            yPos += (summaryLines.length * 4) + 5;

            // --- Skills ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("SKILLS", margin, yPos);
            yPos += 6;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            const skillsText = userSkills.join(', ');
            const skillsLines = doc.splitTextToSize(skillsText, 170);
            doc.text(skillsLines, margin, yPos);
            yPos += (skillsLines.length * 4) + 5;

            // --- Experience ---
            if (experienceCount > 0) {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("EXPERIENCE", margin, yPos);
                yPos += 6;
                for (let i = 1; i <= experienceCount; i++) {
                    const title = document.getElementById(`exp-title-${i}`).value;
                    const company = document.getElementById(`exp-company-${i}`).value;
                    const start = document.getElementById(`exp-start-${i}`).value;
                    const end = document.getElementById(`exp-end-${i}`).value;
                    const desc = document.getElementById(`exp-desc-${i}`).value;
                    
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(`${title.toUpperCase()} | ${company}`, margin, yPos);
                    
                    doc.setFont("helvetica", "italic");
                    doc.text(`${start} - ${end}`, 190, yPos, { align: 'right' });
                    yPos += 5;

                    doc.setFont("helvetica", "normal");
                    const descLines = doc.splitTextToSize(desc, 165);
                    doc.text(descLines, margin + 5, yPos);
                    yPos += (descLines.length * 4) + 4;
                }
            }
            
            // --- Projects ---
             if (projectCount > 0) {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("PROJECTS", margin, yPos);
                yPos += 6;
                 for (let i = 1; i <= projectCount; i++) {
                    const name = document.getElementById(`proj-name-${i}`).value;
                    const desc = document.getElementById(`proj-desc-${i}`).value;
                    const tech = document.getElementById(`proj-tech-${i}`).value;
                    
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(name.toUpperCase(), margin, yPos);
                    yPos += 5;

                    doc.setFont("helvetica", "normal");
                    const descLines = doc.splitTextToSize(desc, 165);
                    doc.text(descLines, margin + 5, yPos);
                    yPos += (descLines.length * 4) + 2;

                    doc.setFont("helvetica", "italic");
                    doc.text(`Technologies: ${tech}`, margin + 5, yPos);
                    yPos += 6;
                }
            }

            // --- Education ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("EDUCATION", margin, yPos);
            yPos += 6;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text(education, margin, yPos);
            yPos += 5;
            doc.setFont("helvetica", "normal");
            doc.text(fieldOfStudy, margin, yPos);

            // --- Save PDF ---
            doc.save(`${name.replace(/\s+/g, '_')}_Resume.pdf`);
        }
        
        // --- AI Mentor Chat Functions ---
        
        async function handleChatMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addMessageToChat('user', userMessage);
            chatInput.value = '';
            chatTypingIndicator.classList.remove('hidden');

            try {
                const aiResponse = await getMentorResponse(userMessage);
                addMessageToChat('ai', aiResponse);
            } catch (error) {
                console.error("Error with mentor chat:", error);
                addMessageToChat('ai', "Sorry, I'm having trouble connecting. Please try again in a moment.");
            } finally {
                chatTypingIndicator.classList.add('hidden');
            }
        }
        
        function addMessageToChat(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (sender === 'user') {
                 chatHistory.push({role: "user", parts: [{ text: message }] });
            } else {
                 chatHistory.push({role: "model", parts: [{ text: message }] });
            }
        }

        async function getMentorResponse(userMessage) {
            const apiKey = "AIzaSyB0FBnF8QlDZJSxHnYlbDi8ddgkQR1Ik4I";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const recommendedCareers = careerRecommendations.map(c => c.title).join(' and ');
            const systemPrompt = `You are a friendly and experienced career mentor. The user you are talking to has skills in [${userSkills.join(', ')}] and has been recommended careers like ${recommendedCareers}. Keep your answers concise, helpful, and encouraging. Your goal is to provide actionable advice, project ideas, or insights into the recommended career paths.`;
            
            // We'll create a temporary history for the API call to include the system prompt
            const apiCallContents = [
                ...chatHistory,
                 {role: "user", parts: [{ text: userMessage }] }
            ];

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: apiCallContents,
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                })
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text.trim();
            } else {
                console.log(result);
                throw new Error("Invalid response structure from AI mentor chat.");
            }
        }

    </script>
</body>
</html>


